<!DOCTYPE HTML>
<html>
    <head>
        <title>Access Overview</title>
    </head>
    <body>
        <h1>Access Overview</h1>
        <div id="content">
            <div id="filters">
                <fieldset>
                    <legend>Filters</legend>
                    <label><input type="checkbox" id="filter-only-ok" checked>Only OK</label>
                    <label><input type="checkbox" id="filter-only-public" checked>Only Public</label>
                </fieldset>
            </div>
            <section id="top-pages"></section>
        </div>
        <script language="JavaScript">
            const pageFilters = {
                'only-ok': (record) => record.statusCode < 300,
                'only-public': (record) => !record.path.match(/^\/admin.*/)
            };

            Object.keys(pageFilters).forEach((name) =>
                document.querySelector(`#filter-${name}`).onchange = toggleFilter(name)
            );

            refresh().then(() => setInterval(refresh, 5000));

            function refresh() {
                return loadData().then(render);
            }
            
            function loadData() {
                return fetch('https://www.jimkinsey.com/admin/metrics/access.json', {
                        credentials: 'same-origin'
                    })
                    .then((response) => {
                        return response.json();
                    })
            }

            let selectedFilters = Object.keys(pageFilters).filter((name) => {
                let input = document.querySelector(`input#filter-${name}`);
                return (input) && input.checked
            });

            function combinedFilter(names) {
                const filters = names.map((name) => pageFilters[name]);
                return filters.reduce((acc, next) => {
                    return (input) => acc(input) && next(input)
                }, () => true)
            }

            function render(data) {
                renderTopPages(data); 
            }

            function toggleFilter(name) {
                return (event) => {
                    if (event.target.checked) {
                        selectedFilters.push(name);
                    } else {
                        selectedFilters = selectedFilters.filter((filter) => filter !== name);
                    }
                    refresh();
                }
            }

            function renderTopPages(data) {

                let topPages = data.records.filter(combinedFilter(selectedFilters)).reduce((acc, curr) => {
                    let page = acc.find((p) => p.path === curr.path);
                    if (page) {
                        page.hits++;
                    }
                    else {
                        acc.push({ hits: 1, path: curr.path });
                    }
                    return acc;
                }, []).sort((a,b) => b.hits - a.hits);
                                
                let topPagesHTML = `<header><h2>Page views</h2></header>
                    <table>
                        <thead>
                            <tr><th>Hits</th><th>Path</th></tr>
                        </thead>
                        <tbody>
                            ${topPages.map(({hits, path}) => `<tr><td>${hits}</td><td>${path}</td></tr>`)}
                        </tbody>
                    </table>`;
                
                document.getElementById('top-pages').innerHTML = topPagesHTML;
            }
        </script>
    </body>
</html>